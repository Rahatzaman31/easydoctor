import{g as e,r as s,j as t}from"./react-vendor-KvxbO3mS.js";import{s as a,i as n}from"./index-D0fMXm6Q.js";import{o as r}from"./vendor-ZcaEhcQo.js";import"./editor-vendor-CSPj58cm.js";import"./supabase-DvSZys4T.js";const i=e=>{const s=["০","১","২","৩","৪","৫","৬","৭","৮","৯"];return String(e).replace(/[0-9]/g,e=>s[parseInt(e)])};function o(){const o=e(),c=s.useRef(null),d=s.useRef(!1),[l,m]=s.useState(!0),[x,p]=s.useState(!1),[g,h]=s.useState(""),[u,f]=s.useState(""),[j,b]=s.useState(""),[y,N]=s.useState(null),[v,k]=s.useState(!1);s.useEffect(()=>{if(d.current)return;const e=new URLSearchParams(window.location.search).get("paymentID");if(e){const s=`payment_callback_${e}`,t=sessionStorage.getItem(s);if("completed"===t||"processing"===t){m(!1);return sessionStorage.getItem("pendingPaidAppointment")?void 0:void o("/")}d.current=!0,sessionStorage.setItem(s,"processing")}!async function(){const e=new URLSearchParams(window.location.search),s=e.get("paymentID"),t=e.get("status");if(!s||!t)return h("পেমেন্ট তথ্য পাওয়া যায়নি।"),void m(!1);const r=sessionStorage.getItem("pendingPaidAppointment");if(!r)return h("সেশন ডাটা পাওয়া যায়নি। অনুগ্রহ করে আবার বুকিং শুরু করুন।"),void m(!1);if("success"===t)try{const e=await fetch("/api/bkash/execute-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentID:s})}),t=await e.json();t.success?(b(t.trxID),await async function(e,s,t){const r=`payment_callback_${s}`;try{if(!a||!n)return h("ডাটাবেস সংযোগ নেই। Transaction ID: "+e),void sessionStorage.removeItem(r);const{data:i}=await a.from("paid_appointments").select("id, booking_ref").eq("payment_id",s).maybeSingle();if(i){sessionStorage.setItem(r,"completed"),sessionStorage.removeItem("pendingPaidAppointment"),f(i.booking_ref);const{data:e}=await a.from("paid_appointments").select("*").eq("id",i.id).single();return e&&N(e),void p(!0)}const o=JSON.parse(t),{formData:c,doctorId:d,doctorName:l,doctorCategory:m,doctorChamberAddress:x}=o;if(!c.patient_name||!c.patient_phone)return h("ফর্ম ডাটা অসম্পূর্ণ। Transaction ID: "+e),void sessionStorage.removeItem(r);const g="PD"+Date.now().toString().slice(-8),u={doctor_id:d,doctor_name:l,doctor_category:m,chamber_address:x,...c,booking_ref:g,status:"confirmed",payment_status:"paid",payment_method:"bkash",payment_amount:100,transaction_id:e,payment_id:s},{error:j}=await a.from("paid_appointments").insert([u]);if(j){if("23505"===j.code){const{data:e}=await a.from("paid_appointments").select("*").eq("payment_id",s).single();if(e)return f(e.booking_ref),N(e),p(!0),sessionStorage.setItem(r,"completed"),void sessionStorage.removeItem("pendingPaidAppointment")}throw j}sessionStorage.setItem(r,"completed"),sessionStorage.removeItem("pendingPaidAppointment"),N({...u,booking_ref:g}),f(g),p(!0)}catch(i){h("অ্যাপয়েন্টমেন্ট সংরক্ষণ করতে সমস্যা। Transaction ID: "+e),sessionStorage.removeItem(r)}}(t.trxID,s,r)):h(t.message||"পেমেন্ট যাচাই করতে সমস্যা হয়েছে।")}catch(i){h("পেমেন্ট যাচাই করতে সমস্যা হয়েছে।")}else"failure"!==t&&"cancel"!==t||h("পেমেন্ট বাতিল হয়েছে বা ব্যর্থ হয়েছে।");m(!1)}()},[]);const w=e=>{if(!e)return"";return new Date(e).toLocaleDateString("bn-BD",{year:"numeric",month:"long",day:"numeric",weekday:"long"})},_=async()=>{if(c.current){k(!0);try{const e=await r(c.current,{backgroundColor:"#ffffff",scale:2,useCORS:!0,logging:!1}),s=document.createElement("a");s.download=`পেইড_সিরিয়াল_${u}.png`,s.href=e.toDataURL("image/png"),s.click()}catch(e){alert("ডাউনলোড করতে সমস্যা হয়েছে।")}finally{k(!1)}}};return l?t.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50",children:t.jsxs("div",{className:"bg-white rounded-xl p-8 text-center",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-pink-600 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600",children:"পেমেন্ট যাচাই করা হচ্ছে..."})]})}):g?t.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4",children:t.jsxs("div",{className:"bg-white rounded-xl p-6 max-w-sm w-full text-center",children:[t.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:t.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),t.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-2",children:"সমস্যা হয়েছে"}),t.jsx("p",{className:"text-gray-600 mb-6",children:g}),t.jsx("button",{onClick:()=>o("/"),className:"w-full bg-pink-600 hover:bg-pink-700 text-white font-medium py-3 px-4 rounded-lg",children:"হোম পেইজে ফিরে যান"})]})}):x&&y?t.jsx("div",{className:"fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-2 sm:p-4",children:t.jsxs("div",{className:"bg-white rounded-xl sm:rounded-2xl shadow-2xl w-full max-w-sm sm:max-w-md max-h-[95vh] flex flex-col",children:[t.jsxs("div",{ref:c,className:"bg-white rounded-t-xl sm:rounded-t-2xl overflow-hidden flex-1 overflow-y-auto",children:[t.jsxs("div",{className:"bg-white p-4 sm:p-5 text-center sticky top-0 border-b border-gray-100",children:[t.jsx("img",{src:"/logo-icon.png",alt:"Logo",className:"w-14 h-14 sm:w-16 sm:h-16 mx-auto mb-2 rounded-full"}),t.jsx("h1",{className:"text-base sm:text-lg font-bold text-gray-800",children:"Rangpur Doctor Appointment"})]}),t.jsxs("div",{className:"p-3 sm:p-4",children:[t.jsxs("div",{className:"bg-pink-50 border-2 border-pink-200 rounded-lg p-3 mb-4 text-center",children:[t.jsx("p",{className:"text-gray-600 text-xs mb-0.5",children:"বুকিং রেফারেন্স"}),t.jsx("p",{className:"text-xl sm:text-2xl font-bold text-pink-600",children:u})]}),t.jsxs("div",{className:"space-y-3",children:[t.jsxs("div",{className:"bg-gray-50 rounded-lg p-2.5 sm:p-3",children:[t.jsxs("h3",{className:"font-semibold text-gray-700 text-xs sm:text-sm mb-2 flex items-center gap-1.5",children:[t.jsx("svg",{className:"w-4 h-4 text-pink-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),"ডাক্তার তথ্য"]}),t.jsxs("div",{className:"space-y-2 text-xs sm:text-sm",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"ডাক্তার"}),t.jsx("p",{className:"font-medium text-gray-800",children:y.doctor_name})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"বিভাগ"}),t.jsx("p",{className:"font-medium text-gray-800",children:y.doctor_category||"-"})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"অ্যাপয়েন্টমেন্ট তারিখ"}),t.jsx("p",{className:"font-medium text-pink-600",children:w(y.appointment_date)})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"চেম্বার ঠিকানা"}),t.jsx("p",{className:"font-medium text-gray-800",children:y.chamber_address||"-"})]})]})]}),t.jsxs("div",{className:"bg-gray-50 rounded-lg p-2.5 sm:p-3",children:[t.jsxs("h3",{className:"font-semibold text-gray-700 text-xs sm:text-sm mb-2 flex items-center gap-1.5",children:[t.jsx("svg",{className:"w-4 h-4 text-blue-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),"রোগীর তথ্য"]}),t.jsxs("div",{className:"grid grid-cols-3 gap-2 text-xs sm:text-sm",children:[t.jsxs("div",{className:"col-span-2",children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"নাম"}),t.jsx("p",{className:"font-medium text-gray-800",children:y.patient_name})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"বয়স/লিঙ্গ"}),t.jsxs("p",{className:"font-medium text-gray-800",children:[i(y.patient_age),"/",(S=y.patient_gender,"male"===S?"পুরুষ":"female"===S?"মহিলা":"অন্যান্য").charAt(0)]})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"মোবাইল"}),t.jsx("p",{className:"font-medium text-gray-800",children:y.patient_phone})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"ঠিকানা"}),t.jsxs("p",{className:"font-medium text-gray-800 text-[11px] sm:text-xs",children:[y.upazila,", ",y.district]})]})]})]}),t.jsxs("div",{className:"bg-green-50 rounded-lg p-2.5 sm:p-3",children:[t.jsxs("h3",{className:"font-semibold text-green-700 text-xs sm:text-sm mb-2 flex items-center gap-1.5",children:[t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),"পেমেন্ট তথ্য"]}),t.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs sm:text-sm",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"মাধ্যম"}),t.jsx("p",{className:"font-medium text-green-700",children:"বিকাশ"})]}),t.jsxs("div",{children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"পরিশোধিত"}),t.jsxs("p",{className:"font-medium text-green-700",children:[i(100)," টাকা"]})]}),j&&t.jsxs("div",{className:"col-span-2",children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"ট্রানজেকশন আইডি"}),t.jsx("p",{className:"font-medium text-green-700 text-xs",children:j})]})]})]}),y.problem_description&&t.jsxs("div",{className:"bg-gray-50 rounded-lg p-2.5 sm:p-3",children:[t.jsx("p",{className:"text-gray-500 text-[10px] sm:text-xs",children:"সমস্যার বিবরণ"}),t.jsx("p",{className:"font-medium text-gray-800 text-xs sm:text-sm",children:y.problem_description})]}),t.jsx("div",{className:"bg-pink-50 border border-pink-200 rounded-lg p-2 text-center",children:t.jsx("p",{className:"text-[10px] sm:text-xs text-pink-700",children:"এই তথ্যটি সংরক্ষণ করুন এবং চেম্বারে দেখান"})})]})]})]}),t.jsxs("div",{className:"p-3 border-t bg-gray-50 rounded-b-xl sm:rounded-b-2xl flex gap-2 shrink-0",children:[t.jsx("button",{onClick:()=>o("/"),className:"flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-2.5 px-3 rounded-lg text-sm transition-colors",children:"হোম পেইজ"}),t.jsx("button",{onClick:_,disabled:v,className:"flex-1 bg-pink-600 hover:bg-pink-700 text-white font-medium py-2.5 px-3 rounded-lg text-sm transition-colors disabled:opacity-50 flex items-center justify-center gap-1.5",children:v?t.jsxs(t.Fragment,{children:[t.jsxs("svg",{className:"animate-spin h-4 w-4",viewBox:"0 0 24 24",children:[t.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none"}),t.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),t.jsx("span",{children:"ডাউনলোড..."})]}):t.jsxs(t.Fragment,{children:[t.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:t.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"})}),t.jsx("span",{children:"ডাউনলোড"})]})})]})]})}):null;var S}export{o as default};
